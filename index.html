<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Forklift Intelligence Platform</title>
<style>
  body { font-family: Arial, sans-serif; line-height: 1.35; padding: 12px; }
  select, input { padding: 6px; min-width: 260px; }
  button { padding: 8px 12px; cursor: pointer; }
  .card { margin-top: 12px; padding: 12px; border: 1px solid #ccc; border-radius: 8px; }
  .muted { color: #666; font-size: 13px; }
  .row { margin: 8px 0; }
</style>
</head>
<body>

<h2>Forklift Year Decoder</h2>

<div class="row">
<label>Manufacturer:</label>
<select id="manufacturer"></select>
</div>

<div class="row">
<label>Model:</label>
<select id="model_select"></select>
<input type="text" id="model_text" placeholder="Type model (if not in dropdown)" style="display:none;">
<div class="muted" id="model_hint"></div>
</div>

<div class="row">
<label>Serial:</label>
<input type="text" id="serial" placeholder="Enter forklift serial">
</div>

<button id="btn">Decode Forklift Year</button>
<div id="result"></div>

<hr style="margin:40px 0;">

<h2>Battery Date Decoder</h2>

<div class="row">
<label>Battery Manufacturer:</label>
<select id="battery_manufacturer"></select>
</div>

<div class="row">
<label>Battery Serial:</label>
<input type="text" id="battery_serial">
</div>

<button id="battery_date_btn">Decode Battery Date</button>
<div id="battery_date_result"></div>

<hr style="margin:40px 0;">

<h2>Battery Size Detector</h2>

<div class="row">
<label>Forklift Manufacturer:</label>
<select id="battery_forklift_manufacturer"></select>
</div>

<div class="row">
<label>Forklift Model:</label>
<input type="text" id="battery_model">
</div>

<button id="battery_size_btn">Detect Battery Size</button>
<div id="battery_size_result"></div>

<script>
document.addEventListener("DOMContentLoaded", function(){

const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvbGV5enJoZXhrZGRyeWZ4em56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1OTg3NDQsImV4cCI6MjA4NzE1NDc0NH0.vYwvjNDE6Gistzk-5k2DDXIxmfr8wrnyXkvhMB0Ciuk";

const ENDPOINT_DECODE    = "https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/decode_forklift";
const ENDPOINT_MODELS    = "https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/get_models";
const ENDPOINT_BATT_DATE = "https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/decode_battery";
const ENDPOINT_BATT_SIZE = "https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/detect_battery_size";
const ENDPOINT_BATT_MFGS = "https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/get_battery_manufacturers";

const MANUFACTURERS = [
"Aisle-Master","Allis-Chalmers","Balkancar","Barrett","Bendi",
"Big Joe","Blue Giant","Case","Caterpillar","Clark",
"Combilift","Crown","Daewoo / Doosan","Drexel","Hangcha",
"Harlow","Heli","Hyster","Hyundai","JCB",
"Jungheinrich","Kalmar","Komatsu","Linde","Manitou",
"Mitsubishi","Nissan","Raymond","Sellick","Tailift",
"TCM","Toyota","Unicarriers","Yale"
];

function el(id){ return document.getElementById(id); }
function headers(){
return {
"Content-Type":"application/json",
"apikey":ANON_KEY,
"Authorization":"Bearer "+ANON_KEY
};
}

function populateManufacturers(){
const m = el("manufacturer");
const b = el("battery_forklift_manufacturer");
m.innerHTML="";
b.innerHTML="";
MANUFACTURERS.forEach(name=>{
let o1=document.createElement("option");
o1.value=name; o1.text=name; m.appendChild(o1);
let o2=document.createElement("option");
o2.value=name; o2.text=name; b.appendChild(o2);
});
}

function currentModel(){
if(el("model_text").style.display!=="none")
return el("model_text").value.trim();
return el("model_select").value.trim();
}

async function loadModels(){
const manufacturer = el("manufacturer").value;
const modelSelect = el("model_select");
modelSelect.innerHTML="";
try{
const res = await fetch(ENDPOINT_MODELS,{
method:"POST",
headers:headers(),
body:JSON.stringify({ manufacturer_input:manufacturer })
});
const data = await res.json();
if(!res.ok || !Array.isArray(data) || data.length===0){
el("model_select").style.display="none";
el("model_text").style.display="inline-block";
return;
}
el("model_select").style.display="inline-block";
el("model_text").style.display="none";
data.forEach(m=>{
let opt=document.createElement("option");
opt.value=m; opt.text=m; modelSelect.appendChild(opt);
});
}catch(e){
el("model_select").style.display="none";
el("model_text").style.display="inline-block";
}
}

async function decodeForkliftYear(){

const mfg = el("manufacturer").value;
const model = currentModel();
const serial = el("serial").value.trim();
if(!serial){ el("result").innerHTML="Enter serial."; return; }

/* ================= HYUNDAI ================= */
if(mfg==="Hyundai"){
// 9th from end letter rule
if(serial.length >= 9){
const char = serial.charAt(serial.length - 9);
const map = {
"A":2010,"B":2011,"C":2012,"D":2013,"E":2014,
"F":2015,"H":2016,"J":2017,"I":2018,"K":2019,
"L":2020,"M":2021
};
if(map[char]){
el("result").innerHTML="<b>Hyundai</b><br>Year: "+map[char];
return;
}
}
// pre 2010 numeric rule
const lastChar = serial.charAt(serial.length - 9);
if(!isNaN(lastChar)){
if(lastChar==="9"){ el("result").innerHTML="<b>Hyundai</b><br>Year: 2009"; return;}
if(lastChar==="8"){ el("result").innerHTML="<b>Hyundai</b><br>Year: 2008"; return;}
if(lastChar==="7"){ el("result").innerHTML="<b>Hyundai</b><br>Year: 2007"; return;}
}
}

/* ================= JCB ================= */
// JCB handled by database ranges only

/* ================= DEFAULT DATABASE ================= */
const res = await fetch(ENDPOINT_DECODE,{
method:"POST",
headers:headers(),
body:JSON.stringify({
manufacturer_input:mfg,
model_input:model,
serial_input:serial
})
});
const data = await res.json();
if(!res.ok){
el("result").innerHTML="Decode error";
return;
}
el("result").innerHTML="<b>"+mfg+" "+model+"</b><br>Year: "+(data.manufacture_year||"Unknown");
}

async function decodeBatteryDate(){
const mfg=el("battery_manufacturer").value;
const serial=el("battery_serial").value.trim();
if(!mfg||!serial){ el("battery_date_result").innerHTML="Enter battery info."; return; }
const res=await fetch(ENDPOINT_BATT_DATE,{
method:"POST",
headers:headers(),
body:JSON.stringify({ manufacturer_input:mfg, serial_input:serial })
});
const data=await res.json();
if(!res.ok){ el("battery_date_result").innerHTML="Error"; return; }
el("battery_date_result").innerHTML="<b>"+data.manufacturer+"</b><br>Year: "+(data.manufacture_year||"Unknown");
}

async function detectBatterySize(){
const mfg=el("battery_forklift_manufacturer").value;
const model=el("battery_model").value.trim();
if(!mfg||!model){ el("battery_size_result").innerHTML="Enter forklift info."; return; }
const res=await fetch(ENDPOINT_BATT_SIZE,{
method:"POST",
headers:headers(),
body:JSON.stringify({ manufacturer_input:mfg, model_input:model, year_input:null })
});
const data=await res.json();
if(!res.ok||!data.found){ el("battery_size_result").innerHTML="No battery fitment found."; return; }
let html="";
data.battery_options.forEach((opt,i)=>{
html+="<div><b>Option "+(i+1)+"</b><br>Voltage: "+opt.voltage+"V<br>AH: "+opt.amp_hour_range+"<br>Tray: "+opt.tray_dimensions+"</div><hr>";
});
el("battery_size_result").innerHTML=html;
}

el("btn").addEventListener("click",decodeForkliftYear);
el("battery_date_btn").addEventListener("click",decodeBatteryDate);
el("battery_size_btn").addEventListener("click",detectBatterySize);
el("manufacturer").addEventListener("change",loadModels);

populateManufacturers();
loadModels();

});
</script>

</body>
</html>
