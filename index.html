<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Forklift Intelligence Platform</title>
<style>
  body { font-family: Arial, sans-serif; padding: 12px; }
  select, input { padding: 6px; min-width: 260px; }
  button { padding: 8px 12px; cursor: pointer; }
  .card { margin-top: 12px; padding: 12px; border: 1px solid #ccc; border-radius: 8px; }
  .muted { color: #666; font-size: 13px; }
  .row { margin: 8px 0; }
</style>
</head>
<body>

<h2>Forklift Year Decoder</h2>

<div class="row">
<label>Manufacturer:</label>
<select id="manufacturer"></select>
</div>

<div class="row">
<label>Model:</label>
<select id="model_select"></select>
<input type="text" id="model_text" placeholder="Type model (if not in dropdown)" style="display:none;">
<div id="model_hint" class="muted"></div>
</div>

<div class="row">
<label>Serial:</label>
<input type="text" id="serial" placeholder="Enter forklift serial">
</div>

<button id="btn">Decode Forklift Year</button>
<div id="result"></div>

<hr style="margin:40px 0;">

<h2>Battery Date Decoder</h2>
<div class="row">
<label>Battery Manufacturer:</label>
<select id="battery_manufacturer"></select>
</div>
<div class="row">
<label>Battery Serial:</label>
<input type="text" id="battery_serial">
</div>
<button id="battery_date_btn">Decode Battery Date</button>
<div id="battery_date_result"></div>

<hr style="margin:40px 0;">

<h2>Battery Size Detector</h2>
<div class="row">
<label>Forklift Manufacturer:</label>
<select id="battery_forklift_manufacturer"></select>
</div>
<div class="row">
<label>Forklift Model:</label>
<input type="text" id="battery_model">
</div>
<button id="battery_size_btn">Detect Battery Size</button>
<div id="battery_size_result"></div>

<script>
document.addEventListener("DOMContentLoaded", function(){

const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvbGV5enJoZXhrZGRyeWZ4em56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1OTg3NDQsImV4cCI6MjA4NzE3NDc0NH0.vYwvjNDE6Gistzk-5k2DDXIxmfr8wrnyXkvhMB0Ciuk";

const ENDPOINT_DECODE    = "https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/decode_forklift";
const ENDPOINT_MODELS    = "https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/get_models";
const ENDPOINT_BATT_DATE = "https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/decode_battery";
const ENDPOINT_BATT_SIZE = "https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/detect_battery_size";
const ENDPOINT_BATT_MFGS = "https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/get_battery_manufacturers";

const MANUFACTURERS = [
"Aisle-Master","Allis-Chalmers","Balkancar","Barrett","Bendi","Big Joe",
"Blue Giant","Case","Caterpillar","Clark","Combilift","Crown",
"Daewoo / Doosan","Drexel","Hangcha","Harlow","Heli","Hyster",
"Hyundai","JCB","Jungheinrich","Kalmar","Komatsu","Linde",
"Manitou","Maximal","Mitsubishi","Nissan","Princeton","Raymond",
"Sellick","Tailift","Taylor","TCM","Toyota","Unicarriers","Yale"
];

function el(id){ return document.getElementById(id); }
function headers(){ return {
"Content-Type":"application/json",
"apikey":ANON_KEY,
"Authorization":"Bearer "+ANON_KEY
};}

function setCard(id, html){
el(id).innerHTML = '<div class="card">'+html+'</div>';
}

function populateManufacturers(){
const main = el("manufacturer");
const batt = el("battery_forklift_manufacturer");
main.innerHTML="";
batt.innerHTML="";
MANUFACTURERS.forEach(m=>{
let o1=document.createElement("option");
o1.value=m; o1.text=m; main.appendChild(o1);
let o2=document.createElement("option");
o2.value=m; o2.text=m; batt.appendChild(o2);
});
main.value="Toyota";
batt.value="Toyota";
}

function currentModel(){
if(el("model_text").style.display!=="none") return el("model_text").value.trim();
return el("model_select").value.trim();
}

/* ================= LOAD MODELS ================= */

async function loadModels(){
const mfg = el("manufacturer").value;
const select = el("model_select");
select.innerHTML="";

try{
const res = await fetch(ENDPOINT_MODELS,{
method:"POST",
headers:headers(),
body:JSON.stringify({ manufacturer_input:mfg })
});
const data = await res.json();
if(res.ok && Array.isArray(data) && data.length>0){
el("model_select").style.display="inline-block";
el("model_text").style.display="none";
data.forEach(m=>{
let opt=document.createElement("option");
opt.value=m; opt.text=m; select.appendChild(opt);
});
}else{
el("model_select").style.display="none";
el("model_text").style.display="inline-block";
}
}catch(e){
el("model_select").style.display="none";
el("model_text").style.display="inline-block";
}
}

/* ================= YEAR DECODER ================= */

async function decodeForkliftYear(){

const mfg = el("manufacturer").value;
const model = currentModel();
const serial = el("serial").value.trim();

if(!serial){ setCard("result","Enter serial."); return; }

/* Raymond */
if(mfg==="Raymond"){
let m=serial.match(/^(\d{3})-(\d{2})-/);
if(!m){ setCard("result","Invalid Raymond serial."); return; }
let yy=parseInt(m[2],10);
let year=yy<=new Date().getFullYear()%100?2000+yy:1900+yy;
setCard("result","<b>Raymond "+m[1]+"</b><br>Year: "+year);
return;
}

/* Hangcha */
if(mfg==="Hangcha"){
let letter = serial[3];
let map={D:2014,E:2015,F:2016,G:2017,H:2018,I:2019,J:2020,A:2021,B:2022};
if(map[letter]){
setCard("result","<b>Hangcha</b><br>Year: "+map[letter]);
return;
}
}

/* Combilift */
if(mfg==="Combilift"){
let yy=parseInt(serial.substring(0,2),10);
let year=yy<=new Date().getFullYear()%100?2000+yy:1900+yy;
setCard("result","<b>Combilift</b><br>Year: "+year);
return;
}

/* Big Joe */
if(mfg==="Big Joe"){
let num=parseInt(serial);
if(num>=333384 && num<=338000) setCard("result","Year: 1990-1991");
return;
}

/* Heli */
if(mfg==="Heli"){
// if serial starts with model
let yearMatch=serial.match(/(\d{4})$/);
if(yearMatch){
let yy=parseInt(yearMatch[1].substring(0,2));
let year=yy<=new Date().getFullYear()%100?2000+yy:1900+yy;
setCard("result","<b>Heli</b><br>Year: "+year);
return;
}
}

/* Default DB */
try{
const res = await fetch(ENDPOINT_DECODE,{
method:"POST",
headers:headers(),
body:JSON.stringify({
manufacturer_input:mfg,
model_input:model,
serial_input:serial
})
});
const data = await res.json();
if(res.ok){
setCard("result","<b>"+mfg+" "+model+"</b><br>Year: "+(data.manufacture_year||"Unknown"));
}else{
setCard("result","Decode error.");
}
}catch(e){
setCard("result","Decode failed.");
}

}

/* ================= BATTERY DATE ================= */

async function decodeBatteryDate(){
const mfg=el("battery_manufacturer").value;
const serial=el("battery_serial").value.trim();
if(!mfg||!serial){ setCard("battery_date_result","Enter battery info."); return; }
const res=await fetch(ENDPOINT_BATT_DATE,{
method:"POST", headers:headers(),
body:JSON.stringify({ manufacturer_input:mfg, serial_input:serial })
});
const data=await res.json();
if(res.ok) setCard("battery_date_result","Year: "+(data.manufacture_year||"Unknown"));
else setCard("battery_date_result","Error.");
}

/* ================= BATTERY SIZE ================= */

async function detectBatterySize(){
const mfg=el("battery_forklift_manufacturer").value;
const model=el("battery_model").value.trim();
if(!mfg||!model){ setCard("battery_size_result","Enter forklift info."); return; }
const res=await fetch(ENDPOINT_BATT_SIZE,{
method:"POST", headers:headers(),
body:JSON.stringify({ manufacturer_input:mfg, model_input:model, year_input:null })
});
const data=await res.json();
if(res.ok && data.found){
let html="";
data.battery_options.forEach((opt,i)=>{
html+="<b>Option "+(i+1)+"</b><br>Voltage: "+opt.voltage+"V<br>AH: "+opt.amp_hour_range+"<br>Tray: "+opt.tray_dimensions+"<hr>";
});
el("battery_size_result").innerHTML=html;
}else setCard("battery_size_result","No battery fitment found.");
}

/* ================= INIT ================= */

populateManufacturers();
loadModels();
el("manufacturer").addEventListener("change",loadModels);
el("btn").addEventListener("click",decodeForkliftYear);
el("battery_date_btn").addEventListener("click",decodeBatteryDate);
el("battery_size_btn").addEventListener("click",detectBatterySize);

});
</script>

</body>
</html>
