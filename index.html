<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Forklift Intelligence Platform</title>
<style>
body { font-family: Arial; padding: 20px; }
.card { margin-top:15px; padding:15px; border:1px solid #ccc; border-radius:8px; }
select,input { padding:6px; min-width:260px; }
button { padding:8px 12px; }
</style>
</head>
<body>

<h2>Forklift Year Decoder</h2>

<label>Manufacturer:</label>
<select id="manufacturer">
<option>Toyota</option>
<option>Hyster</option>
<option>Yale</option>
<option>Crown</option>
<option>Raymond</option>
<option>Case</option>
<option>Allis-Chalmers</option>
<option>Aisle-Master</option>
<option>Blue Giant</option>
<option>Bendi</option>
<option>Big Joe</option>
<option>Hangcha</option>
<option>Harlow</option>
</select>

<br><br>

<label>Model:</label>
<select id="model"></select>

<br><br>

<label>Serial:</label>
<input type="text" id="serial" placeholder="Enter forklift serial">

<br><br>

<button id="btn">Decode Forklift Year</button>

<div id="result"></div>

<hr style="margin:40px 0;">

<h2>Battery Date Decoder</h2>

<label>Battery Manufacturer:</label>
<select id="battery_manufacturer"></select>

<br><br>

<label>Battery Serial:</label>
<input type="text" id="battery_serial">

<br><br>

<button id="battery_date_btn">Decode Battery Date</button>

<div id="battery_date_result"></div>

<hr style="margin:40px 0;">

<h2>Battery Size Detector</h2>

<label>Forklift Manufacturer:</label>
<select id="battery_forklift_manufacturer">
<option>Toyota</option>
<option>Crown</option>
<option>Hyster</option>
<option>Yale</option>
<option>Mitsubishi</option>
<option>Raymond</option>
<option>Case</option>
<option>Allis-Chalmers</option>
<option>Aisle-Master</option>
<option>Blue Giant</option>
<option>Bendi</option>
<option>Big Joe</option>
<option>Hangcha</option>
<option>Harlow</option>
</select>

<br><br>

<label>Forklift Model:</label>
<input type="text" id="battery_model">

<br><br>

<button id="battery_size_btn">Detect Battery Size</button>

<div id="battery_size_result"></div>

<script>
document.addEventListener("DOMContentLoaded", function(){

const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvbGV5enJoZXhrZGRyeWZ4em56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1OTg3NDQsImV4cCI6MjA4NzE3NDc0NH0.vYwvjNDE6Gistzk-5k2DDXIxmfr8wrnyXkvhMB0Ciuk";

const ENDPOINT_DECODE    = "https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/decode_forklift";
const ENDPOINT_MODELS    = "https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/get_models";
const ENDPOINT_BATT_DATE = "https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/decode_battery";
const ENDPOINT_BATT_SIZE = "https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/detect_battery_size";
const ENDPOINT_BATT_MFGS = "https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/get_battery_manufacturers";

function el(id){ return document.getElementById(id); }

function headers(){
return {
"Content-Type":"application/json",
"apikey":ANON_KEY,
"Authorization":"Bearer "+ANON_KEY
};
}

function showCard(id,html){
el(id).innerHTML='<div class="card">'+html+'</div>';
}

/* ================= LOAD MODELS ================= */

async function loadModels(){
const manufacturer = el("manufacturer").value;
const modelSelect = el("model");
modelSelect.innerHTML = "";

const res = await fetch(ENDPOINT_MODELS,{
method:"POST",
headers:headers(),
body:JSON.stringify({ manufacturer_input:manufacturer })
});

const data = await res.json();

if(!res.ok || !Array.isArray(data)) return;

data.forEach(m=>{
const opt=document.createElement("option");
opt.value=m;
opt.text=m;
modelSelect.appendChild(opt);
});
}

/* ================= YEAR DECODER ================= */

async function decodeForkliftYear(){

const mfg = el("manufacturer").value;
const model = el("model").value;
const serial = el("serial").value.trim();

if(!serial){
showCard("result","Enter serial number.");
return;
}

/* RAYMOND */
if(mfg==="Raymond"){
const match=serial.match(/^(\d{3})-(\d{2})-/);
if(!match){ showCard("result","Invalid Raymond serial."); return; }
const yy=parseInt(match[2],10);
const year=yy<=new Date().getFullYear()%100?2000+yy:1900+yy;
showCard("result","<b>Raymond</b><br>Year: "+year);
return;
}

/* HANGCHA */
if(mfg==="Hangcha"){
const yearMap={
"D":2014,"E":2015,"F":2016,"G":2017,"H":2018,
"I":2019,"J":2020,"A":2021,"B":2022
};
if(serial.length<4){ showCard("result","Invalid Hangcha serial."); return; }
const letter=serial.charAt(3).toUpperCase();
if(!yearMap[letter]){ showCard("result","Unknown Hangcha year letter."); return; }
showCard("result","<b>Hangcha</b><br>Year: "+yearMap[letter]);
return;
}

/* HARLOW */
if(mfg==="Harlow"){
const s=parseInt(serial.replace(/\D/g,""),10);
if(!s){ showCard("result","Invalid Harlow serial."); return; }
const table=[
{min:44805,year:1979},{min:48275,year:1980},{min:51940,year:1981},
{min:54203,year:1982},{min:55880,year:1983},{min:57040,year:1985},
{min:58528,year:1986},{min:70083,year:1987},{min:71171,year:1988},
{min:73108,year:1989},{min:74059,year:1990},{min:77513,year:1991},
{min:77892,year:1992},{min:78504,year:1993},{min:79729,year:1994},
{min:81036,year:1995},{min:82481,year:1996},{min:84357,year:1997},
{min:87224,year:1998},{min:89722,year:1999},{min:90010,year:2000},
{min:90285,year:2001},{min:90537,year:2002},{min:90719,year:2003},
{min:90941,year:2004},{min:91255,year:2005},{min:91691,year:2006},
{min:100365,year:2007},{min:100648,year:2008},{min:100860,year:2009},
{min:100989,year:2010},{min:101087,year:2011},{min:101355,year:2012},
{min:101905,year:2013},{min:102120,year:2014},{min:102182,year:2015},
{min:102494,year:2016},{min:102645,year:2017},{min:103964,year:2018},
{min:104503,year:2020}
];
let yearFound="Unknown";
for(let i=table.length-1;i>=0;i--){
if(s>=table[i].min){ yearFound=table[i].year; break; }
}
showCard("result","<b>Harlow</b><br>Year: "+yearFound);
return;
}

/* DEFAULT DB */
const res=await fetch(ENDPOINT_DECODE,{
method:"POST",
headers:headers(),
body:JSON.stringify({
manufacturer_input:mfg,
model_input:model,
serial_input:serial
})
});
const data=await res.json();
if(!res.ok){ showCard("result","Decode error"); return; }
showCard("result","<b>"+mfg+"</b><br>Year: "+(data.manufacture_year||"Unknown"));
}

/* ================= BATTERY ================= */

async function decodeBatteryDate(){
const mfg=el("battery_manufacturer").value;
const serial=el("battery_serial").value.trim();
if(!mfg||!serial){ showCard("battery_date_result","Enter battery info."); return; }
const res=await fetch(ENDPOINT_BATT_DATE,{method:"POST",headers:headers(),body:JSON.stringify({ manufacturer_input:mfg, serial_input:serial })});
const data=await res.json();
if(!res.ok){ showCard("battery_date_result","Error"); return; }
showCard("battery_date_result","<b>"+data.manufacturer+"</b><br>Year: "+(data.manufacture_year||"Unknown"));
}

async function detectBatterySize(){
const mfg=el("battery_forklift_manufacturer").value;
const model=el("battery_model").value.trim();
if(!mfg||!model){ showCard("battery_size_result","Enter forklift info."); return; }
const res=await fetch(ENDPOINT_BATT_SIZE,{method:"POST",headers:headers(),body:JSON.stringify({ manufacturer_input:mfg, model_input:model, year_input:null })});
const data=await res.json();
if(!res.ok||!data.found){ showCard("battery_size_result","No battery fitment found."); return; }
let html="";
data.battery_options.forEach((opt,i)=>{
html+="<b>Option "+(i+1)+"</b><br>Voltage: "+opt.voltage+"V<br>AH: "+opt.amp_hour_range+"<br>Tray: "+opt.tray_dimensions+"<hr>";
});
showCard("battery_size_result",html);
}

/* EVENTS */
el("btn").addEventListener("click",decodeForkliftYear);
el("battery_date_btn").addEventListener("click",decodeBatteryDate);
el("battery_size_btn").addEventListener("click",detectBatterySize);
el("manufacturer").addEventListener("change",loadModels);

loadModels();

});
</script>

</body>
</html>
