<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Forklift Intelligence Platform</title>
</head>
<body>

<h2>Forklift Year Decoder</h2>

<label>Manufacturer:</label>
<select id="manufacturer">
<option>Toyota</option>
<option>Hyster</option>
<option>Yale</option>
<option>Crown</option>
<option>Raymond</option>
<option>Allis-Chalmers</option>
</select>

<br><br>

<label>Model:</label>
<input type="text" id="model">

<br><br>

<label>Serial:</label>
<input type="text" id="serial">

<br><br>

<button id="btn">Decode Forklift Year</button>

<div id="result"></div>

<script>
document.addEventListener("DOMContentLoaded", function(){

const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvbGV5enJoZXhrZGRyeWZ4em56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1OTg3NDQsImV4cCI6MjA4NzE3NDc0NH0.vYwvjNDE6Gistzk-5k2DDXIxmfr8wrnyXkvhMB0Ciuk";

const ENDPOINT_DECODE =
"https://qoleyzrhexkddryfxznz.supabase.co/rest/v1/rpc/decode_forklift";

function el(id){ return document.getElementById(id); }

async function decodeForkliftYear(){

const mfg = el("manufacturer").value;
const model = el("model").value.trim();
const serial = el("serial").value.trim();

if(!mfg || !serial){
el("result").innerHTML = "Enter manufacturer and serial.";
return;
}

/* ================= RAYMOND ================= */

if(mfg==="Raymond"){
const match = serial.match(/^(\d{3})-(\d{2})-/);

if(!match){
el("result").innerHTML="Invalid Raymond serial format.";
return;
}

const yearDigits=parseInt(match[2],10);
const currentYY=new Date().getFullYear()%100;
const year = yearDigits<=currentYY?2000+yearDigits:1900+yearDigits;

el("result").innerHTML =
"<b>Raymond "+match[1]+"</b><br>Year: "+year;
return;
}

/* ================= ALLIS-CHALMERS ================= */

if(mfg==="Allis-Chalmers"){

// System 1: 1-71-08-57
const dashMatch = serial.match(/^\d-(\d{2})-\d{2}-\d+/);

if(dashMatch){
const yearDigits=parseInt(dashMatch[1],10);
const year = yearDigits>=70 ? 1900+yearDigits : 2000+yearDigits;
el("result").innerHTML =
"<b>Allis-Chalmers</b><br>Year: "+year+
"<br>Method: 1971-1974 dash system";
return;
}

// System 2: BFD-42356
const letterMatch = serial.match(/^([A-Z]{3})-\d+/i);

if(letterMatch){
const yearLetter = letterMatch[1][2].toUpperCase();

const yearMap = {
A:1974,B:1975,C:1976,D:1977,E:1978,
H:1979,J:1980,K:1981,L:1982,N:1983,
P:1984,Q:1985,R:1986,S:1987,T:1988,
U:1989,W:1990,X:1991,Z:1992
};

if(yearMap[yearLetter]){
el("result").innerHTML =
"<b>Allis-Chalmers</b><br>Year: "+
yearMap[yearLetter]+
"<br>Method: 1974-1992 3-letter system";
return;
}
}

el("result").innerHTML =
"Invalid Allis-Chalmers serial format.";
return;
}

/* ================= DATABASE FALLBACK ================= */

const res = await fetch(ENDPOINT_DECODE,{
method:"POST",
headers:{
"Content-Type":"application/json",
"apikey":ANON_KEY,
"Authorization":"Bearer "+ANON_KEY
},
body:JSON.stringify({
manufacturer_input:mfg,
model_input:model,
serial_input:serial
})
});

const data = await res.json();

if(!res.ok){
el("result").innerHTML =
"Decode error: "+(data.message||JSON.stringify(data));
return;
}

el("result").innerHTML =
"<b>"+mfg+" "+model+"</b><br>Year: "+
(data.manufacture_year??"Unknown");

}

el("btn").addEventListener("click",decodeForkliftYear);

});
</script>

</body>
</html>
